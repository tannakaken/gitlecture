\documentclass[12pt, unicode]{beamer}
\usetheme{CambridgeUS}
\usepackage{luatexja}

\title{Gitによるバージョン管理入門}
\author{田中 健策（株式会社ぺあのしすてむ）}
\date[2019/10/30]{第五回（最終回）}

\begin{document}

\frame{\maketitle}

\begin{frame}{前回までのあらすじと今回のあらすじ}

前回までのあらすじ
\begin{itemize}
\item プルリクエストを使ったブランチのレビューとマージの自動化と記録
\item Github Actionsを使ったコンパイルとリリースの自動化
\end{itemize}

今回はGitの内部構造といくつかの細かい機能について説明する。

これを知っておくとGitにおけるトラブルシューティングに役に立つからだ。

\end{frame}
\begin{frame}{Gitの内部構造　１}
Gitの内部構造は全て.gitディレクトリにある。

hooksディレクトリには以前説明したgitフックのスクリプトが入っている。

configファイルにはこのリポジトリ独自の設定が入っている。

indexファイルにはgit addされて、これから記録されるファイルが登録されている。

特に重要なのは
\begin{itemize}
\item objectsディレクトリ
\item refsディレクトリ
\item HEADファイル
\end{itemize}
である。

\end{frame}
\begin{frame}{Gitの内部構造　２}

objectsにはgitに記録された全てのファイルやディレクトリが圧縮されて保存されている。
そのobjectにはそのデータのhashがgit内の名前として割り当てられる。

refsディレクトリには、branchの先頭やtagとして登録されたobjectsが収納されている。

HEADファイルは、現在gitが指し示しているobjectが収納されている。

git switch（checkout）によってHEADの位置が変わり、その位置のobjectがgitで管理されたディレクトリ（ワーキングツリーと呼ぶ）に、展開される。

git commitをすると、indexに登録されたファイルが圧縮されてgitのobjectsに加えられ、現在のHEADに付け加えられて、refsやHEADが動かされる。

\end{frame}
\begin{frame}{失われた時を求めて　１}

HEADがbranchの先頭を見ていれば、git commitをしても、branchの先頭のrefが動き、HEADはそのrefを見ているだけである。
しかし、git switch（checkout）で、branchの途中を見ている時に、commitすると、
HEADはそのobjectを見るが、ブランチの先頭のrefは動かない。

その状態で、他のブランチに移動してしまうと、先ほどのコミットはどのrefからも届かないobjectになってしまう。
つまり歴史が消えてしまったのだ。

その他にもgit reset --hard（HEADの位置、インデックス、ワーキングツリーなどが全て戻される）などをして、意図的に歴史を消去することもできる。

\end{frame}
\begin{frame}{失われた時を求めて　２}

しかし消えてしまった記録も、しばらくはobjectsの中に残っている。
そのかつてrefで示されていたlogをgit reflogで調べられる。

これを使えば、消えてしまった記録を復元できる。

復元するためのコマンドはgit cherrypickである。
これを使えば、あるコミットの変更を自分のワーキングツリーに反映できる。


\end{frame}
\begin{frame}{変更の一時待避}

またgit stashを使えば、変更をcommitせずに一時的に記録し、
元の状態に戻すことができる。

急に対応をしなくてはいけない変更などがある場合に便利だ。

\end{frame}
\begin{frame}{便利なログ}

.gitのlogディレクトリには、そのブランチのログが収納されている。
git logは様々なオプションをつけることで、得たい情報を上手く収集することができる。

\begin{itemize}
\item 特定のファイルの変更を追いかける
\item 特定のファイルがいつ消されたかを特定する
\end{itemize}

などができる。

欲しい機能は大体あるので、悩まずに検索してみよう。

またgit bisectというコマンドを使うと、
問題が起こったコミットをbinary searchを使って効率的に探すことができる。

\end{frame}

\end{document}
